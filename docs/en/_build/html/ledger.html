

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Ledger &mdash; hyperchain  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Bucket tree" href="bucket_tree.html" />
    <link rel="prev" title="Consensus" href="consensus.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> hyperchain
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Get Started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Pre-requisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="hyperchain_samples.html">Hyperchain Samples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architecture:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="txflow.html">Transaction Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="consensus.html">Consensus</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Ledger</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blockchain-data">2. Blockchain data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#block">Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transaction">Transaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#receipt">Receipt</a></li>
<li class="toctree-l3"><a class="reference internal" href="#invalid-transaction-record">Invalid Transaction Record</a></li>
<li class="toctree-l3"><a class="reference internal" href="#chain">Chain</a></li>
<li class="toctree-l3"><a class="reference internal" href="#consensus-comparison">Consensus comparison</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#world-state">3. World state</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#account-type">Account type</a></li>
<li class="toctree-l3"><a class="reference internal" href="#account-set">Account set</a></li>
<li class="toctree-l3"><a class="reference internal" href="#atomicity">Atomicity</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bucket_tree.html">Bucket tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="smart_contract.html">Smart Contract</a></li>
<li class="toctree-l1"><a class="reference internal" href="p2p_introduce.html">P2P</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Privacy &amp;&amp; Security:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ca_manager.html">Digital Certificate</a></li>
<li class="toctree-l1"><a class="reference internal" href="namespace.html">Namespace</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptography Algorithm</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User manual:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="JSON-RPC_manual.html">JSON-RPC API</a></li>
<li class="toctree-l1"><a class="reference internal" href="node_op.html">Node Operation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Developers’ Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Roadmap:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Hyperchain Roadmap</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperchain</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Ledger</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/ledger.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ledger">
<h1>Ledger<a class="headerlink" href="#ledger" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The ledger is an important module in the hyperchain platform and is
responsible for the maintenance and organization of the blockchain
ledger data. Ledger data can be divided into two parts.</p>
<ul class="simple">
<li><p>Blockchain data</p></li>
<li><p>Account data</p></li>
</ul>
<p>Among them, the blockchain data include:</p>
<ul class="simple">
<li><p>block,</p></li>
<li><p>transaction</p></li>
<li><p>receipt</p></li>
<li><p>other data.</p></li>
</ul>
<p>This part is what we call the blockchain in the traditional sense. The
latter refers to the collection of all account states on the blockchain,
collectively referred to as world states. Because hyperchain supports
smart contracts, as with Ethereum, it discards Bitcoin’s UTXO model and
uses an account model to organize the data, so this part of the data is
called account data.</p>
<p>Blockchain data is mainly concatenated in blocks. All blocks are chained
sequentially from back to front in a chain, with each block pointing to
its parent block. Block contains a number of transactions, the consensus
module is responsible for unified packaging and sequencing. After
receiving a block, the block chain node executes the transaction in turn
based on the original account status, and during this period reads /
writes the status data of the relevant account. The execution of a
transaction means that the state of the blockchain has undergone a
transition.</p>
<p>Each transaction, in the hyperchain will have a transaction receipt or
illegal transaction records to indicate the final execution result. If
the transaction is a valid transaction, the execution result of the
transaction will be recorded in the transaction receipt after the
execution is completed. Conversely, the cause of the error is recorded
in an illegal transaction record.</p>
<p>The logical relationship between the various parts of the ledger can be
as follows.</p>
<div class="figure align-default">
<img alt="" src="../../images/ledger_arch.jpeg" />
</div>
</div>
<div class="section" id="blockchain-data">
<h2>2. Blockchain data<a class="headerlink" href="#blockchain-data" title="Permalink to this headline">¶</a></h2>
<p>In this chapter, we describe the relationship between the following data
structures：</p>
<ul class="simple">
<li><p>Block</p></li>
<li><p>Transaction</p></li>
<li><p>Receipt</p></li>
<li><p>Chain</p></li>
<li><p>Invalid Transaction Record</p></li>
</ul>
<p>The first two types of data structures form “blockchain data” in the
blockchain network, which is the data that needs to be “consensus” in
the blockchain network. The latter three types of data structures are
maintained locally by each node. The above five data structures make up
all the blockchain data in one node.</p>
<div class="section" id="block">
<h3>Block<a class="headerlink" href="#block" title="Permalink to this headline">¶</a></h3>
<p>The block structure can be divided into two parts：</p>
<ul class="simple">
<li><p>Header</p></li>
<li><p>Body</p></li>
</ul>
<p>The block header mainly contains some blockchain metadata, including:
(1) block height (2) block hash (3) parent block hash (4) world state
hash (5) transaction set hash (6) receipt set hash (7) timestamp (8) log
filtering data.</p>
<p>Block body contains all the transaction data.</p>
<p>The main function of the block is to encapsulate the transaction data
and record the blockchain meta data.</p>
</div>
<div class="section" id="transaction">
<h3>Transaction<a class="headerlink" href="#transaction" title="Permalink to this headline">¶</a></h3>
<p>The transaction is initiated by an external user and records the
user-specified call information in the transaction.</p>
<p>Transactions can be divided into two categories based on whether smart
contracts are executed：</p>
<ul class="simple">
<li><p>normal transaction；</p></li>
<li><p>contract transaction；</p></li>
<li><p>contract deployment</p></li>
<li><p>contract invocation</p></li>
</ul>
<p>The former means that the execution of the transaction does not perform
the operation of the smart contract, only the hyperchain token transfer.</p>
<p>The latter that the will trigger smart contract code running.</p>
<p>The latter can be divided to two categories：</p>
<ol class="arabic simple">
<li><p>contract deployment transaction</p></li>
<li><p>contract invocation transaction.</p></li>
</ol>
<p>Transaction includes these fields：</p>
<ul class="simple">
<li><p><strong>Version</strong>：Indicating the version of the transaction data
structure, for backward compatibility;</p></li>
<li><p><strong>Transaction initiator</strong>：Identification of the initiator of the
transaction, 20 bytes in length;</p></li>
<li><p><strong>Transaction receiver</strong>：Identification of the recipient of the
transaction, 20 bytes in length.</p></li>
<li><p>If the transaction type is contract invocation, the field is the
address of the contract to be invoked;</p></li>
<li><p>If the field is empty, it indicates that the transaction type is
contract deployment;</p></li>
<li><p><strong>Calling information</strong>:</p></li>
<li><p>If the transaction is a normal transaction, specify the number of
tokens that need to be transferred in the calling information;</p></li>
<li><p>If the transaction is a contract invocation transaction, specify the
function to be called and the calling parameter in the calling
information;</p></li>
<li><p>If the transaction is a contract deployment transaction, You need to
specify the contract’s binary code in the call information;</p></li>
<li><p><strong>Random value</strong>：Random uint64;</p></li>
<li><p><strong>Transaction Signature</strong>：The user uses his private key to sign
the content of five fields of (1) transaction initiator (2)
transaction receiver (3) call information (4) timestamp (5) random
value, and the generated signature content is filled in the field to
prevent the contents of the transaction been tampered;</p></li>
<li><p><strong>Transaction Hash</strong>：Hash the above (1) - (5) fields together with
the transaction signature to obtain a hash value indicating the
transaction;</p></li>
</ul>
</div>
<div class="section" id="receipt">
<h3>Receipt<a class="headerlink" href="#receipt" title="Permalink to this headline">¶</a></h3>
<p>Each legitimate transaction, the results of its execution will be
packaged into a transaction receipt stored in the blockchain.
Transaction receipt includes:</p>
<ul class="simple">
<li><p><strong>Version</strong>：Indicates the version information defined by the
receipt data structure for backward compatibility;</p></li>
<li><p><strong>Transaction Hash</strong>：Transaction hash associated with this
receipt;</p></li>
<li><p><strong>Contract Address</strong>：If the transaction is a contract for
deployment contract, the newly deployed contract address is placed in
the field, otherwise the field is empty;</p></li>
<li><p><strong>Execution Result</strong>：If the transaction is a contract invocation
transaction, the result of the execution is placed in the field,
otherwise the field is empty;</p></li>
<li><p><strong>Contract Logs</strong>：During a smart contract execution, a series of
logs may be generated and the log data is placed in this field;</p></li>
<li><p><strong>Contract Type</strong>：Contract type is placed in this field,
EVM(ethereum virtual machine), JVM or something else.</p></li>
</ul>
</div>
<div class="section" id="invalid-transaction-record">
<h3>Invalid Transaction Record<a class="headerlink" href="#invalid-transaction-record" title="Permalink to this headline">¶</a></h3>
<p>Each illegal transaction, the error message will be packaged into an
illegal transaction record, stored in the local node.</p>
<p>Except transaction data related to the illegal record, the specific
causes of the error will also been recorded, for example: (1) the
balance is insufficient (2) the parameters of the contract invocation
illegal (3) call permission is not enough and so on.</p>
</div>
<div class="section" id="chain">
<h3>Chain<a class="headerlink" href="#chain" title="Permalink to this headline">¶</a></h3>
<p>A local node maintains some blockchain metadata for quick query, so in
the hyperchain there is a data structure named chain that records this
data, including：</p>
<ul class="simple">
<li><p>Latest parent block hash;</p></li>
<li><p>Latest block hash;</p></li>
<li><p>Latest block number;</p></li>
<li><p>Genesis block number: default genesis block number is 0, but can be
affected by <em>data archieve/restore</em>;</p></li>
<li><p>Transaction amount;</p></li>
<li><p>Extra;</p></li>
</ul>
</div>
<div class="section" id="consensus-comparison">
<h3>Consensus comparison<a class="headerlink" href="#consensus-comparison" title="Permalink to this headline">¶</a></h3>
<p>After executing all the transactions in a block, local node needs to
compare the “results” with other nodes in the network, and only when
“enough(quorum)” nodes have same result with local node, these results
will be submitted to the database.</p>
<p>The “execution result” of a block consists of the following contents：</p>
<ul class="simple">
<li><p><strong>World state hash</strong>: During the execution of the transaction, the
world state data will be changed. When all transactions in a block
are executed, the bucket tree is used to perform a hash calculation
on the world state, and the calculation result is the world state
hash.</p></li>
<li><p><strong>Transaction set hash</strong>: Using the <em>important field</em> of each
transaction in the block as input to the sha256 algorithm, hash
result represents the entire transaction set. The important fields
are: (1) transaction initiator (2) transaction receiver (3) call
information (4) timestamp (5) random value；</p></li>
<li><p><strong>Receipt set hash</strong>: Using the <em>important field</em> for each receipt in
a block as input to the sha256 algorithm, hash result represents the
entire set of receipts. The important fields are as follows: (1) VM
execution counters (2) Execution results (3) VM execution logs</p></li>
</ul>
</div>
</div>
<div class="section" id="world-state">
<h2>3. World state<a class="headerlink" href="#world-state" title="Permalink to this headline">¶</a></h2>
<p>The blockchain data mentioned above can in fact be summarized as a
water-flow collection of contract invocation information. The smart
contract needs to read / write the contract status data during the
execution. Now introduce the structure of this part of the data。</p>
<p>Because hyperchain needs to be compatible with EVM (Ethereum Virtual
Machine), and EVM has strong coupling with Ethereum’s account system,
hyperchain’s state is based on Ethereum, and a series of modifications
and optimization have been made.</p>
<div class="section" id="account-type">
<h3>Account type<a class="headerlink" href="#account-type" title="Permalink to this headline">¶</a></h3>
<p>Like Ethereum, accounts in hyperchain can be divided into two
categories:</p>
<ul class="simple">
<li><p><strong>External Account</strong>: The private key of external accounts are
controlled by the users themselves; this type account and can
initiate transaction. Besides, such account does not contain smart
contract codes;</p></li>
<li><p><strong>Contract Account</strong>: The contract account contains an executable
smart contract code and has its own storage space for storing its own
state variables. The operation of the smart contract can be triggered
by initiating a transaction with an external account or by another
contract.</p></li>
</ul>
<p>Although the two types of accounts differ in logic, but share the same
definition:</p>
<p>The metadata for an account includes the following fields:</p>
<ul class="simple">
<li><p><strong>Account address</strong>: 20 bytes, generated by the hash function
according to certain input, regardless of hash conflicts, there will
be no two accounts with the same address;</p></li>
<li><p><strong>Balance</strong>: The balance indicates the number token owned by the
account. Such tokens can be manipulated through smart contracts or
can be traded by initiating normal transaction transfers;</p></li>
<li><p><strong>State variables hash</strong>: A contract account need to store all of its
state variables, a hash value used to represent these state variables
is stored in the field；</p></li>
<li><p><strong>Code hash</strong>: a hash to represents contract code;</p></li>
<li><p><strong>Status</strong>：the status of contract, normal or frozen；</p></li>
<li><p><strong>Birthday</strong>：If the account is a contract account, this block
number when this contract been deployed will be placed in this field;</p></li>
<li><p><strong>Creator</strong>：If the account is a contract account, the creator
address will be placed in this field;</p></li>
<li><p><strong>Deployed list</strong>: If the account is a external account, all contract
address deployed by itself will been recorded in this list;</p></li>
</ul>
<div class="figure align-default">
<img alt="" src="../../images/accounts.jpeg" />
</div>
<p>Except these “simply” data placed in the account metadata, there are (1)
contract source code (2) state variables which require a lot of storage
space data are stored directly to database. Only the hash value is
stored in account metadata.</p>
<p>In fact, contract state variables are a series of key value pairs. In
hyperchain, there is a bucket tree for each contract account to compute
the status hash of the contract state variables.</p>
<p>Each time a transaction is executed and a series of state variables are
modified, these changes can just as input to the bucket tree in order to
quickly calculate the “new” state variables hash。</p>
</div>
<div class="section" id="account-set">
<h3>Account set<a class="headerlink" href="#account-set" title="Permalink to this headline">¶</a></h3>
<div class="figure align-default">
<img alt="" src="../../images/accounts_merkleroot.jpeg" />
</div>
<p>hyperchain serializes the metadata of an account, using the serialized
binary as the content of an account. All account data can eventually be
converted into a series of kv pairs, the key is the address of the
account, and the value is the metadata serialized content.</p>
<p>For the account set, there will be a global bucket tree for the <strong>world
state</strong> hash calculation as shown in the figure.</p>
<p>Each account is serialized as a record in the bucket tree, the hash
value of the entire world state is uniformly calculated by that bucket
tree. This hash value, as a state of the world state, is not only one of
the bases for comparison of the consensus stage but will be recorded
later in the block header.</p>
</div>
<div class="section" id="atomicity">
<h3>Atomicity<a class="headerlink" href="#atomicity" title="Permalink to this headline">¶</a></h3>
<p>Hyperchain uses the batch tool provided by the underlying database
leveldb to ensure the atomicity of the ledger. Hyperchain uses rbft as a
consensus algorithm, so the entire process is split into 3 phases.
During the execution phase, all changes to the ledger will be pre-stored
in a leveldb batch. When the result of this execution passes the
consensus comparison between nodes, the batch will be removed from the
cache and all changes will be placed on the disk.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="bucket_tree.html" class="btn btn-neutral float-right" title="Bucket tree" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="consensus.html" class="btn btn-neutral float-left" title="Consensus" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016-2023, Hangzhou Hyperchain Technology Co., Ltd.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>