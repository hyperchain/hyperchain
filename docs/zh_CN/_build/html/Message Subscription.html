

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>消息订阅MQ &mdash; hyperchain  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="数据监控" href="Data%20Monitor.html" />
    <link rel="prev" title="Simulate合约" href="Simulate%20Contract.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> hyperchain
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">平台介绍:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">平台介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="Version%20information.html">版本信息</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">快速入门:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="General%20Concepts.html">通用概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="Prepare.html">准备工作</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">快速入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="invoking%20contract.html">合约部署及调用</a></li>
<li class="toctree-l1"><a class="reference internal" href="hyperchain_samples.html">使用示例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">基础协议:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="consensus%20mechanism.html">共识机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="Networking%20protocol.html">网络协议</a></li>
<li class="toctree-l1"><a class="reference internal" href="execution%20engine.html">执行引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="Storage%20model.html">存储模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="security%20mechanism.html">加密机制</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">扩展协议:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Architecture%20development.html">架构拓展</a></li>
<li class="toctree-l1"><a class="reference internal" href="Safe%20Privacy.html">安全隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="Governonce%20and%20audit.html">治理与审计</a></li>
<li class="toctree-l1"><a class="reference internal" href="Data%20management.html">数据管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Operation%20manage.html">运维管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20components.html">区块链生态组件</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">用户手册:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Data%20Index.html">数据索引</a></li>
<li class="toctree-l1"><a class="reference internal" href="Data%20Archiving.html">数据归档</a></li>
<li class="toctree-l1"><a class="reference internal" href="Trusted%20File%20Sharing.html">可信文件共享</a></li>
<li class="toctree-l1"><a class="reference internal" href="Oracle.html">预言机</a></li>
<li class="toctree-l1"><a class="reference internal" href="Partition%20Consensus.html">分区共识</a></li>
<li class="toctree-l1"><a class="reference internal" href="Security%20Audit.html">安全审计</a></li>
<li class="toctree-l1"><a class="reference internal" href="Interface%20Authority%20Management.html">接口权限管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chain%20Authority%20Management.html">链级权限管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Simulate%20Contract.html">Simulate合约</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">消息订阅MQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">功能描述</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">MQ介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">使用步骤</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">安装及初始化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">配置说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rabbitmq">安装RabbitMQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kafkamq">安装KafkaMQ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">使用说明</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">完整操作流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jsonrpc">JSONRPC接口</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#queue">注册queue</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">删除queue</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queuename">查询所有的queueName</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rabbitmq-broker">通知节点rabbitmq-broker正常工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exchangername">查询节点的exchangerName</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exchanger">删除exchanger</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sdk">SDK接口</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">订阅</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">解订阅</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">查询指定节点应注册的所有的queue名称</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">通知平台rabbitmq-broker正常工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">查询指定节点exchanger的名称</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">删除指定的exchanger</a></li>
<li class="toctree-l4"><a class="reference internal" href="#demo">消息消费者Demo</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id15">订阅规则</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id16">异常处理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#broker">broker未启动</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">broker宕机</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">节点宕机</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id19">注意事项</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Data%20Monitor.html">数据监控</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">应用场景:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="application.html">应用案例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">更多资源:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Community_Resources.html">社区与资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperchain</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>消息订阅MQ</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/Message Subscription.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mq">
<h1>消息订阅MQ<a class="headerlink" href="#mq" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>功能描述<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>MQ介绍<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>平台MQ服务底层依赖 RabbitMQ（KafkaMQ）服务，用户需要独立与平台启动一个rabbitmq（kafkamq）服务器，我们将rabbitmq（kafkamq）所在的服务器称为rabbitmq-broker（kafkamq-broker），平台提供的MQ服务相当于一个生产者客户端，负责将平台消息推送到rabbitmq-broker（kafkamq-broker）。
消息的消费者作为一个消费者客户端，与rabbitmq-broker（kafkamq-broker）建立连接，等待从rabbitmq-broker（kafkamq-broker）推送出来的消息。</p>
<p><strong>RabbitMQ术语说明</strong></p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>术语名称</p></th>
<th class="head"><p>解释说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>channel</p></td>
<td><p>与rabbitmq-broker建立连接后，可以通过connection创建channel，一个channel对象相当于一个连接会话，是客户端（生产者，消费者）直接用来推送或消费消息的媒介</p></td>
</tr>
<tr class="row-odd"><td><p>queue</p></td>
<td><p>由客户端创建，通过绑定路由键routingkey来决定感兴趣的消息类型，相应的消息会在rabbitmq-broker内部被分发到queue中等待被消费</p></td>
</tr>
<tr class="row-even"><td><p>routingkey</p></td>
<td><p>路由键，标识一种消息</p></td>
</tr>
<tr class="row-odd"><td><p>exchanger</p></td>
<td><p>rabbitmq-broker内部直接接收生产者消息的组件，通过名称标识，exchanger负责将消息按照routingkey分发到相应的queue中</p></td>
</tr>
</tbody>
</table>
<p><strong>KafkaMQ术语说明</strong></p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>术语名称</p></th>
<th class="head"><p>解释说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>topic</p></td>
<td><p>逻辑概念，消息的类别，同一topic的消息可以认为是同一类，在kafka集群中会被作为一类存储。每一条生产者推送的消息，只可以属于一个topic</p></td>
</tr>
<tr class="row-odd"><td><p>partition</p></td>
<td><p>partition是一个物理概念，是kafka集群真正存储数据的地方。一个topic可以包含多个partition，该topic下的消息可以在partition之间做负载均衡。一个partition上存储的消息是有序的</p></td>
</tr>
<tr class="row-even"><td><p>replica</p></td>
<td><p>这是kafka集群内部的概念，可以认为replica是partition的备份</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id3">
<h3>使用步骤<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>独立启动mq服务，一般来讲，只需要一个节点连接mq服务端。需要连接mq服务端的节点只需要在节点配置中启用mq服务，并配置mq服务的地址即可。剩下的操作都可以来API接口进行；</p></li>
<li><p>用户向平台注册自己的消息队列queue，指明queue感兴趣的路由键集合；平台会创建队列同时启动服务，将queue的名称与交换机名称exchanger返回给用户；</p></li>
<li><p>用户正常使用平台发送交易，当有routingkey相应的事件产生时，消息会被MQ服务自动推送至broker，用户可以通过命令行或管理页面查询；</p></li>
<li><p>消费者消费消息；</p></li>
<li><p>用户可以查询当前节点上注册过的所有的queue名称；</p></li>
<li><p>用户可以删除queue，但需要提供注册时平台返回的exchanger。</p></li>
</ol>
</div>
</div>
<div class="section" id="id4">
<h2>安装及初始化<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>配置说明<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">service.service_name</span></code>：节点开启的外部服务。</p></li>
</ul>
<p>开启MQ服务的示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="n">service</span><span class="p">]]</span>
    <span class="n">service_name</span> <span class="o">=</span> <span class="s2">&quot;MQ&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mq.broker</span></code>：MQ的Broker类型，可选项为 <code class="docutils literal notranslate"><span class="pre">rabbit</span></code> 和 <code class="docutils literal notranslate"><span class="pre">kafka</span></code>；</p></li>
</ul>
<p>示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">mq</span><span class="o">.</span><span class="n">broker</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;rabbit&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mq.rabbit.url</span></code>：RabbitMQ地址。</p></li>
</ul>
<p>示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">mq</span><span class="o">.</span><span class="n">rabbit</span><span class="p">]</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;amqp://guest:guest@localhost:5672/&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mq.kafka.urls</span></code>：Kafka地址列表；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mq.kafka.partitionNums</span></code>：每个kafka实例下分区(partition)的数量；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mq.kafka.replicaFactor</span></code>：每个kafka实例在zookeeper下的备份数量。</p></li>
</ul>
<p>示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">mq</span><span class="o">.</span><span class="n">kafka</span><span class="p">]</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;localhost:9092&quot;</span><span class="p">]</span>

<span class="p">[</span><span class="n">mq</span><span class="o">.</span><span class="n">kafka</span><span class="o">.</span><span class="n">partitionNums</span><span class="p">]</span>
<span class="s2">&quot;localhost:9092&quot;</span> <span class="o">=</span> <span class="mi">1</span>

<span class="p">[</span><span class="n">mq</span><span class="o">.</span><span class="n">kafka</span><span class="o">.</span><span class="n">replicaFactor</span><span class="p">]</span>
<span class="s2">&quot;localhost:9092&quot;</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="rabbitmq">
<h3>安装RabbitMQ<a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h3>
<p><strong>下载安装</strong></p>
<ol class="arabic simple">
<li><p>RabbitMQ官方下载地址： <a class="reference external" href="http://www.rabbitmq.com/download.html">http://www.rabbitmq.com/download.html</a> （如未安装Erlang，请首先安装Erlang）</p></li>
<li><p>通过命令行工具直接安装（brew或yum等）</p></li>
</ol>
<p><strong>启动MQ服务</strong></p>
<ol class="arabic simple">
<li><p>当前窗口启动： <cite>rabbitmq-server</cite></p></li>
<li><p>如需开启插件，在启动前设置： <cite>rabbitmq-plugins enable rabbitmq_management</cite></p></li>
<li><p>浏览器打开管理界面： <a class="reference external" href="http://localhost:15672/">http://localhost:15672/</a></p></li>
<li><p>默认用户名和密码：guest,guest</p></li>
</ol>
<p><strong>使用docker容器启动</strong></p>
<p>启动带管理界面的MQ:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">name</span> <span class="n">myrabbitmq</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5672</span><span class="p">:</span><span class="mi">5672</span> <span class="o">-</span><span class="n">p</span> <span class="mi">15672</span><span class="p">:</span><span class="mi">15672</span> <span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">rabbitmq</span><span class="p">:</span><span class="mi">3</span><span class="o">-</span><span class="n">management</span>
</pre></div>
</div>
<p>启动不带管理界面的MQ:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">name</span> <span class="n">myrabbitmq</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5672</span><span class="p">:</span><span class="mi">5672</span> <span class="o">-</span><span class="n">p</span> <span class="mi">15672</span><span class="p">:</span><span class="mi">15672</span> <span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">rabbitmq</span><span class="p">:</span><span class="n">latest</span>
</pre></div>
</div>
</div>
<div class="section" id="kafkamq">
<h3>安装KafkaMQ<a class="headerlink" href="#kafkamq" title="Permalink to this headline">¶</a></h3>
<p>请参考官方文档：
<a class="reference external" href="https://kafka.apachecn.org/quickstart.html">https://kafka.apachecn.org/quickstart.html</a></p>
</div>
</div>
<div class="section" id="id6">
<h2>使用说明<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3>完整操作流程<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>调用informNormal，通知节点与rabbitmqMQ建立连接（kafka可跳过）</p></li>
<li><p>注册队列</p></li>
<li><p>正常发送交易，产生消息</p></li>
<li><p>消费者等待rabbitmq-broker推送的消息</p></li>
<li><p>当queue不再使用时，删除queue</p></li>
</ol>
</div>
<div class="section" id="jsonrpc">
<h3>JSONRPC接口<a class="headerlink" href="#jsonrpc" title="Permalink to this headline">¶</a></h3>
<p>MQ服务对外提供的API有六种，分别用于注册queue、删除queue、查询指定节点注册的所有queue、通知平台rabbitmq-broker正常工作、查询当前节点最新的exchangerName，以及删除指定名称的exchanger。</p>
<p><strong>MQ服务接口详情请参考</strong> <a class="reference external" href="https://docs.hyperchain.cn/document/detail?type=1&amp;id=14">https://docs.hyperchain.cn/document/detail?type=1&amp;id=14</a></p>
<div class="section" id="queue">
<h4>注册queue<a class="headerlink" href="#queue" title="Permalink to this headline">¶</a></h4>
<p>平台接口名称为 <strong>mq_register</strong> ，参数为：RegisterMeta结构，MQ服务将创建与发送目标节点绑定的exchanger。</p>
<p>目前Signature字段暂时为预留字段，平台不会对Signature字段做处理。</p>
<p>目前可选的routingKey字段包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- MQBlock
    - 区块事件，包含区块号、区块哈希、交易列表等
- MQLog
    - 合约内部定义的抛出事件，包含合约地址、抛出事件的具体内容等
- MQException
    - 共识状态异常事件，包含viewChange（主节点切换）、systemBusy（节点打包失败）、recovery（节点数据恢复）、stateUpdate（节点状态更新）、confChange（节点增删）等
- MQFileInfo
    - 可信文件共享相关事件，包含文件内容、文件哈希等
- SignedMQBlock
- SignedMQLog
- SignedMQException
- SignedMQFileInfo
</pre></div>
</div>
<p>其中以 “Signed” 字段开头routingKey，表示该事件推送时，需要附带节点的ECert签名，具体的签名方式为将事件做json序列化，然后用SHA3算法做哈希，再用Ecert签名。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">--</span><span class="n">data</span> <span class="s1">&#39;{</span>
<span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;mq_register&quot;</span><span class="p">,</span>
<span class="s2">&quot;params&quot;</span><span class="p">:[{</span>
    <span class="s2">&quot;addresses&quot;</span><span class="p">:[],</span>
<span class="s2">&quot;toBlock&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;signature&quot;</span><span class="p">:</span><span class="s2">&quot;010492bf5d92d97bfbf6ab67eb6b5ceadee91a73a2e33876a339b3d25e23c9cd2322104eef8a9191bab5728f401adcd95a00f7e3f802bb374598f47593fc82bb0bd23045022047204b8b763f7dab117e530a06c0d9ac6ef2a0b77a1179be46f75ca0efcc450c02210098e9836dc9bbf0d8a39206f7c9bdc3148e3805e79e58d98df3cd0cbe2e42aff6&quot;</span><span class="p">,</span>
<span class="s2">&quot;isVerbose&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
<span class="s2">&quot;topics&quot;</span><span class="p">:[],</span>
<span class="s2">&quot;routingKeys&quot;</span><span class="p">:[</span><span class="s2">&quot;MQBlock&quot;</span><span class="p">,</span>
<span class="s2">&quot;MQLog&quot;</span><span class="p">,</span>
<span class="s2">&quot;MQException&quot;</span><span class="p">],</span>
<span class="s2">&quot;fromBlock&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="s2">&quot;queueName&quot;</span><span class="p">:</span><span class="s2">&quot;gw_node3queue&quot;</span><span class="p">,</span>
<span class="s2">&quot;from&quot;</span><span class="p">:</span><span class="s2">&quot;B2CC762775FC1AA7486AA2FCF0D7885D4EEE4DA2&quot;</span><span class="p">}],</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>返回值示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">queueName</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">node1queue1</span><span class="se">\&quot;</span><span class="s2">,</span>
    \<span class="s2">&quot;exchangerName</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">global_fa34664e_1529920070165345052</span><span class="se">\&quot;</span><span class="s2">}&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>其中的result字段内容为：队列名称(queueName)，exchanger名称(exchangerName)；如果发生异常，这两个返回值为空字符串。</p>
<p>在使用此接口注册订阅了带签名的事件时，需要注意： <strong>平台务必开启Ecert，否则注册不成功</strong>。</p>
</div>
<div class="section" id="id8">
<h4>删除queue<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>平台接口名称为 <strong>mq_unRegister</strong> ，参数为：队列名称，exchanger名称，账户地址，签名（目前只用到前三个）。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">--</span><span class="n">data</span> <span class="s1">&#39;{</span>
<span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;mq_unRegister&quot;</span><span class="p">,</span>
<span class="s2">&quot;params&quot;</span><span class="p">:[</span><span class="s2">&quot;gw_node4queue&quot;</span><span class="p">,</span>
<span class="s2">&quot;global_34d29974_1533616771290750181&quot;</span><span class="p">,</span>
<span class="s2">&quot;B2CC762775FC1AA7486AA2FCF0D7885D4EEE4DA2&quot;</span><span class="p">,</span>
<span class="s2">&quot;010492bf5d92d97bfbf6ab67eb6b5ceadee91a73a2e33876a339b3d25e23c9cd2322104eef8a9191bab5728f401adcd95a00f7e3f802bb374598f47593fc82bb0bd2304502205c7a9e27263fb39ba5e3c6ec1d1fde6bff113577087579a7c23a9c167f93ceaf022100a197f0b514be1dd78ddc480af4372425a26f5b20832b83707e77ae58e1d4994e&quot;</span><span class="p">],</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>返回值示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
<span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="s2">&quot;{</span>
<span class="s2">&quot;count&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
<span class="s2">&quot;error&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">}</span><span class="s2">&quot;}</span>
</pre></div>
</div>
<p>其中result字段内容为：队列中还未消费掉的消息数目(count)，是否删除成功(success)，以及过程中产生的error信息(error，正常情况下为”null”)，如果exchangerName与注册queue时的返回值不匹配，会删除失败。</p>
</div>
<div class="section" id="queuename">
<h4>查询所有的queueName<a class="headerlink" href="#queuename" title="Permalink to this headline">¶</a></h4>
<p>平台接口名称为 <strong>mq_getAllQueueNames</strong> ，不需要参数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">--</span><span class="n">data</span> <span class="s1">&#39;{</span>
<span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;mq_getAllQueueNames&quot;</span><span class="p">,</span>
<span class="s2">&quot;params&quot;</span><span class="p">:[],</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span>
<span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>返回值示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
<span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
<span class="s2">&quot;result&quot;</span><span class="p">:[</span><span class="s2">&quot;node1queue1&quot;</span><span class="p">]}</span>
</pre></div>
</div>
</div>
<div class="section" id="rabbitmq-broker">
<h4>通知节点rabbitmq-broker正常工作<a class="headerlink" href="#rabbitmq-broker" title="Permalink to this headline">¶</a></h4>
<p><strong>注意：该接口仅再以rabbitmq作为mq服务时生效</strong></p>
<p>平台接口为 <strong>mq_informNormal</strong> ，不需要参数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">--</span><span class="n">data</span> <span class="s1">&#39;{</span>
<span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;mq_informNormal&quot;</span><span class="p">,</span>
<span class="s2">&quot;params&quot;</span><span class="p">:[</span><span class="s2">&quot;&quot;</span><span class="p">],</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>返回值示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="s2">&quot;{</span>
    <span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;error&quot;</span><span class="p">:</span><span class="n">null</span>
    <span class="p">}</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="exchangername">
<h4>查询节点的exchangerName<a class="headerlink" href="#exchangername" title="Permalink to this headline">¶</a></h4>
<p><strong>注意：该接口仅再以rabbitmq作为mq服务时生效</strong></p>
<p>平台接口为 <strong>mq_getExchangerName</strong> ，不需要参数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">--</span><span class="n">data</span> <span class="s1">&#39;{</span>
<span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;mq_getExchangerName&quot;</span><span class="p">,</span>
<span class="s2">&quot;params&quot;</span><span class="p">:[],</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>返回值示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="s2">&quot;global_fa34664e_1530265355500005853&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="exchanger">
<h4>删除exchanger<a class="headerlink" href="#exchanger" title="Permalink to this headline">¶</a></h4>
<p><strong>注意：该接口仅再以rabbitmq作为mq服务时生效</strong></p>
<p>平台接口为 <strong>mq_deleteExchanger</strong> ，参数为exchanger名称。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">--</span><span class="n">data</span> <span class="s1">&#39;{</span>
<span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;mq_deleteExchanger&quot;</span><span class="p">,</span>
<span class="s2">&quot;params&quot;</span><span class="p">:[</span><span class="s2">&quot;global_34d29974_1532417825700513378&quot;</span><span class="p">],</span>
<span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span>
<span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>返回值示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="s2">&quot;{</span>
    <span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;error&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">}</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sdk">
<h3>SDK接口<a class="headerlink" href="#sdk" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id9">
<h4>订阅<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p><strong>方法名称</strong>：registerQueue</p>
<p><strong>方法说明</strong>：注册queue队列，只有调用了registerQueue，服务才能够正常工作</p>
<p><strong>输入参数</strong>：</p>
<ul class="simple">
<li><p>RegisterMeta结构体</p></li>
</ul>
<p><strong>返回值</strong>：</p>
<ul class="simple">
<li><p>exchanger名称</p></li>
<li><p>queue名称</p></li>
</ul>
<p><strong>调用示例</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>public String registerQueue(int id){
  ...
  ArrayList&lt;String&gt; array = new ArrayList&lt;String&gt;();
  array.add(&quot;SignedMQBlock&quot;);
  array.add(&quot;MQLog&quot;);
  array.add(&quot;MQException&quot;);
  String qname = &quot;node1queue&quot;;
  MQParam blockInfoParam = new MQParam.Builder().
            //队列订阅相关的参数
            regRoutingKeys(array).  //表示queue绑定的routingKey集合
            regQueueName(qname).    //表示队列名称，已经使用过的队列名称，没有手动删除前，不可以重复使用
            // MQBlock事件订阅需要的参数
            setVerbose(false).      //表示推送区块时是否需要推送交易列表，true表示推送交易列表
            // MQlog事件订阅需要的参数
            fromBlock(&quot;1&quot;).         //表示需要推送log事件的起始区块号
            toBlock(&quot;2&quot;).           //表示需要推送log事件的终止区块号
            addAddress(&quot;0x1258b70e2d620805a5351d8553ca76606a0c6fc5&quot;).   //表示log事件需要匹配的合约地址
            addAddress(&quot;0xea22068f8ef04f6c4b5b73e55b51c4c758c7276e&quot;).   //可多次调用添加多个合约地址
            addTopics(new String[]{&quot;topicA&quot;, &quot;topicB&quot;}).    //表示log事件需要匹配的topic集合
            addTopics(new String[]{&quot;topicC&quot;, &quot;topicD&quot;}).    //可多次调用添加多个topic数组
                            // 是否需要以延迟模式推送，若为true，则可更大程度上保证消息的准确性和顺序性，但消息会在平台checkpoint点之后才会被推送
            .delayMode(false)
                            //请求发起人自身信息
            setFrom(TEST_FROM).     //表示请求发起者的账户地址，用于权限控制
            build(TEST_ACCOUNT_JSON, TEST_PASSWD);  //表示请求者以RegisterMeta结构体为内容，使用自己的私钥做sm2签名，格式为16进制字符串
  String result = hyperchain.registerQueue(blockInfoParam, SPEC_ID);
  return result;
}

/** 输出结果为：
{
    &quot;queueName&quot;: &quot;node1queue&quot;,
    &quot;exchangerName&quot;: &quot;global_fa34664e_1529591668938108811&quot;
}**/
</pre></div>
</div>
<p><strong>MQ中事件Demo</strong></p>
<p>以订阅了SignedMQBlock为例，在rabbitmq-broker中收到的事件内容为:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1564475540778317000</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SignedMQBlock_2dca544db&quot;</span><span class="p">,</span>
    <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SignedMQBlock_2dca544db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;BlockInfo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;0x892d956394af2604ed47567d7999c837a8955444f42d0e6095d5d764cba20c95&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parentHash&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;</span><span class="p">,</span>
        <span class="s2">&quot;writeTime&quot;</span><span class="p">:</span> <span class="mi">1564475540751617000</span><span class="p">,</span>
        <span class="s2">&quot;avgTime&quot;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span>
        <span class="s2">&quot;txcounts&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;merkleRoot&quot;</span><span class="p">:</span> <span class="s2">&quot;0xb746f69f4c87eb4635f4458d06b1e929385f6664292d60ae3efa305728266ead&quot;</span><span class="p">,</span>
        <span class="s2">&quot;txs&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">},</span>
        <span class="s2">&quot;signature&quot;</span><span class="p">:</span> <span class="s2">&quot;304502203b1dcc44c1415aa8f1be35a59f5588b5406965f859c333dd65d3d2ab0b65ad9002210082cdfb9f14abdfa4cbcaf66db1b1886c1440e27e1c93592abc3b51aff1e44638&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cert&quot;</span><span class="p">:</span> <span class="s2">&quot;2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949422b6a43434161476741774942416749424154414b42676771686b6a4f50515144416a424d4d524d77455159445651514b457770496558426c636d4e6f0a59576c754d52597746415944565151444577316f6558426c636d4e6f59576c754c6d4e754d5241774467594456515171457764455a585a6c624739774d5173770a435159445651514745774a6153444167467730784f4441334d7a41774e4445324e546861474138794d5445344d4463774e6a41314d5459314f466f77544445540a4d4245474131554543684d4b53486c775a584a6a61474670626a45574d4251474131554541784d4e61486c775a584a6a614746706269356a626a45514d4134470a413155454b684d48524756325a5778766344454c4d416b474131554542684d43576b67775754415442676371686b6a4f5051494242676771686b6a4f50514d420a42774e43414154564c482f426a3753324e6c457677446d3049656e32773976667474304a306c6664704a3030772b3475386f56536e7265365057525a545948730a5243765066394f4c55547041574e7052694c517a706732714571627a6f3349776344414f42674e56485138424166384542414d43416751774a6759445652306c0a42423877485159494b7759424251554841774947434373474151554642774d424267497141775944675173424d41384741315564457745422f7751464d414d420a41663877445159445652304f424159454241454341775177466759444b6c59424241396f6558426c59326868615735665a574e6c636e5177436759494b6f5a490a7a6a304541774944527741775241496744384c394732765739726f56426f7a2f633445362f54702f57636763717a796c796f30587971474e706234434943775a0a554d346c424b33474c2f69617767593661425a4c2f6945446b66734b37794b6a69395a66457459750a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h4>解订阅<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p><strong>方法名称</strong>：unregisterQueue</p>
<p><strong>方法说明</strong>：删除指定名字的queue，如果queue不存在或者给出了不匹配的excahngerName，都将删除失败</p>
<p><strong>输入参数</strong>：</p>
<ul class="simple">
<li><p>queue名称(string)</p></li>
<li><p>exchanger名称(string)</p></li>
<li><p>发起者地址(string)</p></li>
<li><p>签名(string)</p></li>
<li><p>节点ID(int)</p></li>
</ul>
<p><strong>返回值</strong>：</p>
<ul class="simple">
<li><p>queue删除时仍持有的消息数目</p></li>
<li><p>是否删除成功</p></li>
<li><p>过程中的错误信息</p></li>
</ul>
<p><strong>调用示例</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> public String unRegisterQueue(int id) {
   String qname = &quot;node1queue&quot;;
   String exchName = &quot;global_34d29974_1533616771290750181&quot;;
   String signature = new UnRegParam(qname, exchName).signWithSM2(TEST_ACCOUNT_JSON2, TEST_PASSWD);
   String result = hyperchain.unregisterQueue(qname, exchName, TEST_FROM2, signature, 1);
   return result;
}
/**
 输出结果为：{&quot;count&quot;:0, &quot;success&quot;:true, &quot;error&quot;:&quot;null&quot;}
 ***/
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h4>查询指定节点应注册的所有的queue名称<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p><strong>方法名称</strong>：getAllQueueNames</p>
<p><strong>输入参数</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>节点ID(int)</p></li>
</ul>
</div></blockquote>
<p><strong>返回值</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>queue名称列表</p></li>
</ul>
</div></blockquote>
<p><strong>调用示例</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> public String testGetAllQName(int id) {
   String result = hyperchain.getAllQueueNames(id);
   return result;
}
/**
 输出结果为：[&quot;node1queue&quot;]
 ***/
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h4>通知平台rabbitmq-broker正常工作<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p><strong>方法名称</strong>：informNormal</p>
<p><strong>方法说明</strong>：该方法主要用于在broker宕机后，可以通过调用该方法，通知节点，节点会尝试建立连接以及恢复曾经注册的queue</p>
<p><strong>输入参数</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>rabbitmq-broker的完整url</p></li>
<li><p>节点ID(int)</p></li>
</ul>
</div></blockquote>
<p><strong>返回值</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>平台建立连接，队列恢复的结果</p></li>
</ul>
</div></blockquote>
<p><strong>调用示例</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> public void testInformNormal(String brokerUrl, int id) throws Exception {
     // 空字符串表示使用平台默认url
     String result = hyperchain.informNormal(brokerUrl, id);
     System.out.println(result);
}
/**
 输出结果为：{&quot;success&quot;:true,&quot;error&quot;:null}
 ***/
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h4>查询指定节点exchanger的名称<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p><strong>方法名称</strong>：getExchName</p>
<p><strong>输入参数</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>节点ID(int)</p></li>
</ul>
</div></blockquote>
<p><strong>返回值</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>exchanger名称</p></li>
</ul>
</div></blockquote>
<p><strong>调用示例</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  public String testGetExchangerName(int id) throws Exception {
     String result = hyperchain.getExchName(id);
     return result;
}
/**
输出结果为：&quot;global_fa34664e_1530265355500005853&quot;
***/
</pre></div>
</div>
</div>
<div class="section" id="id14">
<h4>删除指定的exchanger<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p><strong>方法名称</strong>：deleteExchanger</p>
<p><strong>输入参数</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>exchanger名称(String)</p></li>
<li><p>节点ID(int)</p></li>
</ul>
</div></blockquote>
<p><strong>返回值</strong>：</p>
<blockquote>
<div><ul class="simple">
<li><p>是否删除成功</p></li>
</ul>
</div></blockquote>
<p><strong>调用示例</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> public String testDeleteExchanger() throws Exception {
     ...
     String exchName = &quot;global_34d29974_1532437541218895978&quot;;
     String result = hyperchain.deleteExch(exchName, SPEC_ID);
     return result
 }
/***
 输出结果为：&quot;{&quot;success&quot;:true,&quot;error&quot;:null}&quot;
***/
</pre></div>
</div>
</div>
<div class="section" id="demo">
<h4>消息消费者Demo<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h4>
<p>消费者程度调用receiveMsg()接口，可以消费相应的消息，外部程序可以通过getMessages()接口，获得所有消费者消费掉的消息记录</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">HPCMQClient</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">static</span> <span class="n">String</span> <span class="n">qname</span> <span class="o">=</span> <span class="s2">&quot;node1queue1&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">should</span> <span class="n">read</span> <span class="kn">from</span> <span class="nn">properties</span>
    <span class="n">private</span> <span class="n">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">public</span> <span class="n">HPCMQClient</span><span class="p">()</span> <span class="p">{}</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">receiveMsg</span><span class="p">()</span> <span class="n">throws</span> <span class="ne">Exception</span><span class="p">{</span>
        <span class="n">ConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ConnectionFactory</span><span class="p">();</span>
        <span class="n">factory</span><span class="o">.</span><span class="n">setHost</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">);</span>
        <span class="n">factory</span><span class="o">.</span><span class="n">setUsername</span><span class="p">(</span><span class="s2">&quot;guest&quot;</span><span class="p">);</span>
        <span class="n">factory</span><span class="o">.</span><span class="n">setPassword</span><span class="p">(</span><span class="s2">&quot;guest&quot;</span><span class="p">);</span>
        <span class="n">factory</span><span class="o">.</span><span class="n">setPort</span><span class="p">(</span><span class="mi">5672</span><span class="p">);</span>   <span class="o">//</span> <span class="n">should</span> <span class="nb">set</span> <span class="n">your</span> <span class="n">own</span> <span class="n">hostname</span> <span class="ow">and</span> <span class="n">port</span>
        <span class="n">final</span> <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">newConnection</span><span class="p">();</span>
        <span class="n">final</span> <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">createChannel</span><span class="p">();</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">queueDeclare</span><span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="n">false</span><span class="p">,</span> <span class="n">false</span><span class="p">,</span> <span class="n">null</span><span class="p">);</span>
        <span class="n">final</span> <span class="n">Consumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultConsumer</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
            <span class="nd">@Override</span>
            <span class="n">public</span> <span class="n">void</span> <span class="n">handleDelivery</span><span class="p">(</span><span class="n">String</span> <span class="n">consumerTag</span><span class="p">,</span> <span class="n">Envelope</span> <span class="n">envelope</span><span class="p">,</span> <span class="n">AMQP</span><span class="o">.</span><span class="n">BasicProperties</span> <span class="n">properties</span><span class="p">,</span> <span class="n">byte</span><span class="p">[]</span> <span class="n">body</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
                <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">new</span> <span class="n">String</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">);</span>
                <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;[CLIENT] Received &#39;&quot;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
                <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;[CLIENT] Done&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">basicConsume</span><span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="n">consumer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">public</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">getMessages</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">messages</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>目前javasdk提供了对事件验签的功能，接口为MQUtil.verifyEvent，入参为从broker中直接接收到的事件。</p>
</div>
</div>
<div class="section" id="id15">
<h3>订阅规则<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>订阅规则依赖于一个RegisterMeta结构实现，该结构体表现为一个json格式的字符串作为参数传入RegisterQueue()方法，RegisterMeta中不同的字段应用于不同的事件订阅规则，具体如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 排表方式为：变量名称 | 变量类型 |json格式key | 字段含义
type RegisterMeta struct {
    //队列订阅相关的参数
    RoutingKeys    List&lt;string&gt; // `json:&quot;routingKeys&quot;` 表示queue绑定的routingKey集合
    QueueName      string       // `json:&quot;queueName&quot;`   表示队列名称，已经使用过的队列名称，没有手动删除前，不可以重复使用
    //请求发起人自身信息
    From           string   // `json:&quot;from&quot;`      表示请求发起者的账户地址，用于权限控制
    Signature      string   // `json:&quot;signature&quot;` 表示请求者以RegisterMeta结构体为内容，使用自己的私钥做sm2签名，格式为16进制字符串
    // MQBlock事件订阅需要的参数
    IsVerbose      boolean   // `json:&quot;isVerbose&quot;` 表示推送区块时是否需要推送交易列表，true表示推送交易列表
    // MQlog事件订阅需要的参数
    FromBlock      string           // `json:&quot;fromBlock&quot;` 表示需要推送log事件的起始区块号
    ToBlock        string           // `json:&quot;toBlock&quot;`   表示需要推送log事件的终止区块号
    Addresses      List&lt;String&gt;     // `json:&quot;addresses&quot;` 表示log事件需要匹配的合约地址集合
    Topics         List&lt;String[]&gt;   // `json:&quot;topics&quot;`    表示log事件需要匹配的topic集合
    // 该字段为flato（“flato”为趣链区块链平台新版英文简称）1.0.5新增，可选择队列推送模式
    // 若为true，则可更大程度成保证消息的正确性和顺序性（例如砍块造成的被砍区块对应的消息推送以及消息可能发生乱序的情况），
    // 但是需要以延迟推送为代价，消息需要在平台到达checkpoint之后才会被推送到broker
    Delay bool `json:&quot;delay&quot;`
    //目前Exception相关的操作不需要用户提供参数，订阅了Exception事件后，所有的异常都会主动推送
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="id16">
<h2>异常处理<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<div class="section" id="broker">
<h3>broker未启动<a class="headerlink" href="#broker" title="Permalink to this headline">¶</a></h3>
<p>broker未启动时，在不注册队列，不需要消息推送时，平台正常输出日志，在用户调用API发起请求注册队列时，平台会打印错误日志。</p>
</div>
<div class="section" id="id17">
<h3>broker宕机<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>rabbitmq-broker端单方面宕机，宕机之后，平台可以继续的提交区块，但会打印相关的推送消息失败的日志；</p>
<p>在rabbitmq-broker重启恢复后，需要用户再次注册队列，如果注册了与异常发生前同名的队列，则可以自动恢复broker宕机过程中的消息，平台会打印相关的日志提示消息已经恢复。</p>
</div>
<div class="section" id="id18">
<h3>节点宕机<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>节点宕机重启后，需要用户调用InformNormal接口，MQ服务会自动恢复队列，权限映射关系，并将缓存的数据推送到broker。</p>
</div>
</div>
<div class="section" id="id19">
<h2>注意事项<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Log事件中data的编码方式为 <strong>hex</strong> ，按照相应格式解码，即可得到原始的字节数组；</p></li>
<li><p>在启动时使用kafka作为实现时，启动kafka服务之前需要保证kafka带着如下两个配置项启动：</p></li>
</ol>
<p>在配置文件server.properties中增加如下两个配置项</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 40%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>配置项</p></th>
<th class="head"><p>含义</p></th>
<th class="head"><p>值</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>auto.create.topics.enable</p></td>
<td><p>是否自动创建topic</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-odd"><td><p>delete.topic.enable</p></td>
<td><p>是否直接删除topic</p></td>
<td><p>true</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="Data%20Monitor.html" class="btn btn-neutral float-right" title="数据监控" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="Simulate%20Contract.html" class="btn btn-neutral float-left" title="Simulate合约" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Hyperchain Corp..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>